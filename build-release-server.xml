<?xml version="1.0" encoding="UTF-8"?>
<project name="JFritz-Release" default="release-deb" basedir=".">
	<import file="build.xml" />

	<property name="product" value="JFritz" />
	<property name="version" value="unknown" />

	<!-- release properties -->
	<property name="home" value="ant" />
	<property name="dist" value="${home}/dist" />
	<property name="release" value="${home}/release" />
	<property name="update" value="${home}/update" />
	<property name="lib" value="lib" />
	<property name="lib-dev" value="lib-dev" />
	<property name="docs" value="../Doku" />

	<!-- build properties -->
	<property name="build" value="${home}/build" />
	<property name="build.classes" value="${build}/classes" />
	<property name="build.jars" value="${build}/jars" />
	<property name="build.resources" value="${build}/resources" />

	<!-- mac spezifisch -->

	<!-- include all jars in lib to classpath -->
	<path id="build.classpath">
		<fileset dir="${lib}">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<path id="helper.classpath">
		<pathelement location="${build.classes}" />
	</path>

	<path id="test.classpath">
		<path refid="build.classpath" />
		<pathelement location="${build.classes}" />
		<pathelement location="${build.unittests}" />
		<fileset dir="${build}">
			<include name="*.jar" />
		</fileset>
	</path>

	<path id="ant-deb.classpath">
		<fileset dir="${lib-dev}">
			<include name="**/*.jar" />
		</fileset>
	</path>

	<taskdef resource="ant_deb_task.properties" classpathref="ant-deb.classpath"/>

	<target name="prepare" depends="clean, build, getVersion" description="Runs getVersion, clean and build of JFritz!">
	</target>

	<target name="release-deb" depends="prepare" description="Creates a deb-Package for Linux (Debian)">
		<delete dir="${release}/linux" />
		<mkdir dir="${release}" />
		<mkdir dir="${release}/linux" />
		<mkdir dir="${release}/linux/jfritz-${version}" />

		<!-- copy new jfritz-files to linux directory -->
		<copy todir="${release}/linux/jfritz-${version}">
			<fileset dir="${dist}">
			</fileset>
		</copy>

		<!-- copy logo to linux directory -->
		<copy todir="${release}/linux/jfritz-${version}">
			<fileset dir="../../Release/Linux/">
				<include name="jfritz.png" />
			</fileset>
		</copy>

		<!-- do deb-packaging here -->
        <desktopentry
            toFile="${release}/linux/JFritz.desktop"
            name="JFritz"
            comment="An application to communicate with your FRITZ!Box"
            exec="/usr/bin/jfritz"
            icon="/opt/JFritz/jfritz.png"
            categories="Utility;TelephonyTools;Java"
        />

        <deb
            todir="${release}/linux"
            package="jfritz"
            section="utils"
            depends="sun-java5-jre | sun-java6-jre"
        	preinst="../../Release/Linux/preinst"
        >
            <version upstream="${version}"/>
            <maintainer email="Robert Palmer" name="jfritz@robotniko.de"/>
            <description synopsis="An application to communicate with your FRITZ!Box.">
It is possible to get the caller list, manage phonebook contacts, do reverse lookup for unknown phone numbers,
show incoming and outgoing calls in real time and to initiate new calls from the computer.

http://www.jfritz.org/
            </description>
            <tarfileset dir="${release}/linux/jfritz-${version}" prefix="/opt/JFritz">
                <include name="**/**"/>
            	<exclude name="lib/windows/**"/>
            	<exclude name="lib/mac/**"/>
	        	<exclude name="lib/sunos/**"/>
            </tarfileset>

            <tarfileset file="../../Release/Linux/jfritz" prefix="/usr/bin" filemode="755"/>
            <tarfileset dir="../../Release/Linux/" prefix="/usr/share/doc/jfritz">
                <include name="COPYING"/>
                <include name="README-de"/>
                <include name="README-en"/>
            </tarfileset>
            <tarfileset file="${release}/linux/JFritz.desktop" prefix="usr/share/applications"/>
        </deb>

		<delete dir="${release}/linux/jfritz-${version}" />
		<delete>
			<fileset dir="${release}/linux/">
	    		<include name="JFritz.desktop"/>
			</fileset>
		</delete>
	</target>

	<target name="release-linux" depends="prepare, release-deb" description="Creates a tar.gz-Release for Linux!">
		<mkdir dir="${release}/linux/jfritz-${version}" />

		<!-- copy new jfritz-files to linux directory -->
		<copy todir="${release}/linux/jfritz-${version}">
			<fileset dir="${dist}">
			</fileset>
		</copy>

		<tar tarfile="${release}/linux/jfritz-${version}.tar">
			<tarfileset dir="${release}/linux">
				<exclude name="*.deb"/>
			</tarfileset>
		</tar>
		<gzip src="${release}/linux/jfritz-${version}.tar" destfile="${release}/linux/JFritz-${version}.tar.gz" />
		<delete dir="${release}/linux/jfritz-${version}" />
		<delete file="${release}/linux/jfritz-${version}.tar" />
	</target>

	<target name="prepare-mac" depends="prepare" description="Copy new JFritz files to Mac-Template!">
		<delete dir="${release}/mac" />
		<mkdir dir="${release}" />
		<mkdir dir="${release}/mac" />
		<mkdir dir="${release}/mac/tmp" />

		<!-- copy mac-template to release directory -->
		<copy todir="${release}/mac/tmp">
			<fileset dir="../../Release/MAC/Vorlage">
			</fileset>
		</copy>

		<copy file="../../Release/MAC/Vorlage/__MACOSX/JFritz.app/Contents/._Info.plist"
		             tofile="${release}/mac/tmp/__MACOSX/JFritz.app/Contents/._Info.plist" />

		<!-- adapt version string in Info.plist -->
		<copy file="../../Release/MAC/Vorlage/JFritz.app/Contents/Info.plist"
		             tofile="${release}/mac/tmp/JFritz.app/Contents/Info.plist"
					 overwrite="yes">
	        <filterchain>
	           <replacetokens>
					<token key="version" value="${version}"/>
	            </replacetokens>
	        </filterchain>
	    </copy>

		<!-- copy actual changelog -->
		<copy todir="${release}/mac/tmp">
			<fileset dir="${dist}">
				<include name="**/Changelog.txt" />
			</fileset>
		</copy>

		<!-- copy application files -->
		<copy todir="${release}/mac/tmp/JFritz.app/Contents/Resources/Java">
			<fileset dir="${dist}">
			</fileset>
		</copy>

		<chmod file="${release}/mac/tmp/JFritz.app/Contents/JavaApplicationStub" perm="555"/>
	</target>

	<target name="release-mac-zip" depends="prepare-mac, getVersion" description="Creates a ZIP-File for MacOS!">
		<zip destfile="${release}/mac/JFritz-${version}-Mac.zip" basedir="${release}/mac/tmp" />
	</target>

	<target name="release-mac-dmg" depends="prepare-mac, getVersion" description="Creates a DMG-File for MacOS!">
		<waitfor maxwait="15" maxwaitunit="minute" checkevery="10000">
			<available file="${release}/mac/JFritz-${version}.dmg"/>
		</waitfor>

		<mkdir dir="${release}/mac/JFritz-${version}" />
		<!-- copy new package to mac directory -->
		<copy todir="${release}/mac/JFritz-${version}">
			<fileset dir="${release}/mac/">
				<include name="**/JFritz-${version}.dmg" />
			</fileset>
		</copy>
		<delete file="${release}/mac/JFritz-${version}.dmg" />
		<delete dir="${release}/mac/tmp" />
	</target>
</project>